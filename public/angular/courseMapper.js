var app=angular.module("courseMapper",["ngResource","ngRoute","ngCookies","ngTagsInput","ngFileUpload","oc.lazyLoad","relativeDate","wysiwyg.module","VideoAnnotations"]);app.config(["$routeProvider","$locationProvider",function(a,b){a.when("/static/about",{templateUrl:"/static/about",controller:"staticController",reloadOnSearch:!1}).when("/category/:slug",{templateUrl:"courses_list.html",controller:"CourseListController",reloadOnSearch:!1}).when("/cid/:courseId",{templateUrl:"/course/courseDetail",controller:"CourseController",reloadOnSearch:!1}).when("/cid/:courseId/nid/:nodeId",{templateUrl:"/course/nodeDetail",controller:"NodeDetailController",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),app.controller("CategoryListController",["$scope","$http","$rootScope",function(a,b,c){b.get("/api/categories").success(function(b){a.categories=b.categories}),a.$on("sidebarInit",function(a){$.AdminLTE.tree(".sidebar")})}]),app.controller("CourseController",["$scope","$rootScope","$filter","$http","$location","$routeParams","$timeout",function(a,b,c,d,e,f,g){a.course=null,a.enrolled=!1,a.loc=e.absUrl(),a.courseId=f.courseId,a.isOwner=!1,a.currentUrl=window.location.href,a.followUrl=a.currentUrl+"?enroll=1",a.isPlaying=!1,a.currentTab="preview",a.tabs={preview:"preview",analytics:"analytics",map:"map",updates:"updates",discussion:"discussion"},a.changeTab=function(){var b="preview",c=e.search();c.tab&&(b=c.tab),a.currentTab=a.tabs[b],a.actionBarTemplate="actionBar-course-"+a.currentTab},a.init=function(b){d.get("/api/course/"+a.courseId).success(function(c){c.result&&(a.course=c.course,b&&a.course.picture&&(a.course.picture=a.course.picture+"?"+(new Date).getTime()),g(function(){a.$broadcast("onAfterInitCourse",a.course)}))}),a.changeTab()},a.init(),a.$watchGroup(["user","course"],function(){null!=a.user&&null!=a.course&&(d.get("/api/accounts/"+b.user._id+"/course/"+a.courseId).success(function(b){b.result&&b.courses?a.enrolled=b.courses.isEnrolled:a.enrolled=!1}),a.course.createdBy==b.user._id&&(a.isOwner=!0,a.enrolled=!0))}),a.playVideo=function(){a.isPlaying=!0},a.stopVideo=function(){a.isPlaying=!1},a.$on("onAfterEditCourse",function(b,c){a.init(!0)}),a.enroll=function(){var b="/api/course/"+a.course._id+"/enroll";a.loading=!0,d.put(b,{}).success(function(b){b.result&&(a.enrolled=!0)})["finally"](function(){a.loading=!1})},a.leave=function(){var b="/api/course/"+a.course._id+"/leave";a.loading=!0,d.put(b,{}).success(function(b){b.result&&(a.enrolled=!1)})["finally"](function(){a.loading=!1})},a.$on("$routeUpdate",function(){a.changeTab()})}]),app.controller("CourseEditController",["$scope","$filter","$http","$location","Upload",function(a,b,c,d,e){a.createdDate=new Date,a.courseEdit=null,a.tagsRaw=[],a.files=[],a.filespicture=[],a.filesvideo=[],a.errors="",a.$on("onAfterInitCourse",function(b,c){a.init()}),a.init=function(){if(a.tagsRaw=[],a.courseEdit=cloneSimpleObject(a.$parent.course),a.courseEdit&&a.courseEdit.courseTags&&a.courseEdit.courseTags.length>0)for(var b in a.courseEdit.courseTags){var c=a.courseEdit.courseTags[b];a.tagsRaw.push({text:c.name})}},a.saveCourse=function(){a.tagsRaw&&(a.courseEdit.tags=JSON.stringify(a.tagsRaw));var b={url:"/api/course/"+a.courseEdit._id,fields:{name:a.courseEdit.name,description:a.courseEdit.description,tags:a.courseEdit.tags}};b.file=[],a.filespicture&&a.filespicture.length&&b.file.push(a.filespicture[0]),a.filesvideo&&a.filesvideo.length&&b.file.push(a.filesvideo[0]),e.upload(b).progress(function(a){if(a.config.file){var b=parseInt(100*a.loaded/a.total);console.log("progress: "+b+"% "+a.config.file.name)}}).success(function(b,c,d,e){a.$emit("onAfterEditCourse",b.course),a.filespicture=[],a.filesvideo=[],$("#editView").modal("hide")})},a.cancel=function(){a.courseEdit=cloneSimpleObject(a.$parent.course)}}]),app.controller("NewCourseController",["$scope","$filter","$http","$location",function(a,b,c,d){a.course={name:null,category:null,description:""},a.tagsRaw=null,a.errorName="",a.loadTags=function(b){return c.get("/api/category/"+a.category._id+"/courseTags?query="+b)},a.saveCourse=function(){a.tagsRaw&&(a.course.tags=JSON.stringify(a.tagsRaw)),a.course.category=a.$parent.category._id;var b=transformRequest(a.course);c({method:"POST",url:"/api/courses",data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(a.$emit("onAfterCreateNewCourse"),window.location.href="/course/"+b.course.slug+"/#/cid/"+b.course._id+"?new=1"):null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})}}]),app.controller("CourseListController",["$scope","$rootScope","$http","$routeParams","$location","$sce",function(a,b,c,d,e,f){a.slug=d.slug,a.filterTags=[],a.filterTagsText=[],a.availableTags=[],a.courseTags=[],a.category=null,a.courses=null,a.widgets=[],a.getCoursesFromThisCategory=function(){var b="/api/category/"+a.category._id+"/courses",d=[];if(a.filterTags.length>0){for(var e in a.filterTags)d.push(a.filterTags[e]._id);b+="?tags="+d.join(",")}c.get(b).success(function(b){a.courses=b.courses})},a.initTagFromSearch=function(){var b=e.search();if(b&&b.tags){var c=b.tags.split(",");if(c)for(var d in c){var f=c[d];if(a.availableTags)for(var g in a.availableTags){var h=a.availableTags[g];h.slug==f&&a.applyFilter(h,!0)}}}a.getCoursesFromThisCategory(),a.$watch(function(){return e.search()},function(b,c){b&&b!==c&&a.getCoursesFromThisCategory()},!0)},a.getCourseAnalytics=function(b){c.get("/api/server-widgets/course-listing/?cid="+b).success(function(c){c.result&&(a.widgets[b]=f.trustAsHtml(c.widgets))}).error(function(){})},a.applyFilter=function(b,c){arrayObjectIndexOf(a.filterTags,b,"name")<0&&(a.filterTags.push(b),a.filterTagsText.push(b.slug),removeObjectFromArray(a.availableTags,b,"name"),c||a.go())},a.go=function(){a.filterTags.length>0?e.search({tags:a.filterTagsText.join(",")}):e.search({})},a.removeFilter=function(b){if(arrayObjectIndexOf(a.availableTags,b,"name")<0){a.availableTags.push(b),removeObjectFromArray(a.filterTags,b,"name");for(var c=a.filterTagsText.length-1;c>=0;c--)if(a.filterTagsText[c]===b.slug){a.filterTagsText.splice(c,1);break}a.go()}},c.get("/api/category/"+a.slug).success(function(b){a.category=b.category,c.get("/api/category/"+a.category._id+"/courseTags").success(function(b){a.courseTags=b.courseTags,a.availableTags=b.courseTags,a.initTagFromSearch()})})}]),app.controller("MapController",["$scope","$http","$rootScope","$timeout","$sce","$location",function(a,b,c,d,e,f){a.treeNodes=[],a.jsPlumbConnections=[],a.widgets=[],a.isTreeInitiated=!1,a.isCurrentTabIsMap=!1;var g=!1;a.findNode=function(b,c,d,e){if(g)return g;for(var f in b){var h=b[f];if(h[d]&&h[d]==e)return g=h,h;h[c]&&h[c].length>0&&a.findNode(h[c],c,d,e)}return g?g:void 0},$(document).ready(function(){a.width=jQuery(window).width(),a.height=jQuery(window).height(),a.center={x:a.width/2,y:a.height/2-100}}),a.init=function(){$(".center-course").mouseover(function(){$(this).find("ul").show()}).mouseout(function(){$(this).find("ul").hide()}),b.get("/api/treeNodes/course/"+a.course._id).success(function(b){b.result?b.treeNodes.length>0?a.treeNodes=b.treeNodes:a.initJSPlumb():console.log(b.errors)})},a.$on("onAfterInitCourse",function(b,c){a.course=c,a.init()}),a.initDraggable=function(c){var d=(window.innerWidth,window.innerHeight,jsPlumb.getSelector(".course-map .w"));c.draggable(d,{stop:function(){var c=$(this),d=c.position(),e={x:d.left-Canvas.w/2,y:d.top-Canvas.h/2},f=c.attr("id").substring(1);g=!1;var h=a.findNode(a.treeNodes,"childrens","_id",f);b.put("/api/treeNodes/"+f+"/positionFromRoot",e).success(function(a,b){console.log(a),h&&(h.positionFromRoot=e)}).error(function(a,b){console.log("err"),console.log(a)})}})},a.initJSPlumb=function(){console.log("drawing tree"),Tree.init(Canvas.w,Canvas.h);var b=jsPlumb.getInstance({Endpoint:["Blank",{radius:2}],HoverPaintStyle:{strokeStyle:"#3C8DBC",lineWidth:2},PaintStyle:{strokeStyle:"#3C8DBC",lineWidth:2},ConnectionOverlays:[],Container:"course-map"});a.initDraggable(b),b.batch(function(){a.interConnect("center",a.treeNodes,b)})},a.interConnect=function(b,d,e){for(var f in d){var g=d[f],h="t"+g._id;$("#"+h).mouseover(function(){$(this).find("ul").show(),c.$broadcast("onTopicHover",$(this).attr("id"))}).mouseout(function(){$(this).find("ul").hide(),c.$broadcast("onTopicHoverOut",$(this).attr("id"))});var i=e.connect({source:b,target:h,anchors:[["Perimeter",{shape:jsPlumb.getSelector("#"+b)[0].getAttribute("data-shape")}],["Perimeter",{shape:jsPlumb.getSelector("#"+h)[0].getAttribute("data-shape")}]]});a.jsPlumbConnections.push(i),g.childrens&&a.interConnect(h,g.childrens,e)}},a.goToDetail=function(a){window.location.href="/courses/#/category/"+a},a.nodeModaltitle="",a.currentNodeAction={},a.setMode=function(b,d,e){switch(b){case"add":a.currentNodeAction.mode="Add";break;case"edit":a.currentNodeAction.mode="Edit"}switch(d){case"subTopic":a.currentNodeAction.type="subTopic",a.currentNodeAction.typeText="Sub Topic";break;case"contentNode":a.currentNodeAction.type="contentNode",a.currentNodeAction.typeText="Content Node"}a.nodeModaltitle=a.currentNodeAction.mode+" "+a.currentNodeAction.typeText,e?(a.currentNodeAction.parent=e,a.nodeModaltitle+=" under "+e.name):a.currentNodeAction.parent=!1,c.$broadcast("onAfterSetMode",a.$parent.course)},a.$watch(function(){return f.search()},function(b,c){var d=f.search().tab;"map"==d&&(a.isCurrentTabIsMap=!0)},!0),a.$on("jsTreeInit",function(b){a.isTreeInitiated=!0}),a.$watchGroup(["isTreeInitiated","isCurrentTabIsMap"],function(b,c){a.isTreeInitiated===!0&&a.isCurrentTabIsMap===!0&&a.initJSPlumb()}),a.$on("onAfterCreateNode",function(b,c){if(c.parent){g=!1;var e=a.findNode(a.treeNodes,"childrens","_id",c.parent);e&&e.childrens.push(c)}else a.treeNodes.push(c);a.destroyJSPlumb(),a.treeNodes=angular.copy(a.treeNodes),d(function(){a.$apply(),a.initJSPlumb()})}),a.$on("onAfterEditNode",function(b,c){if(c){g=!1;var e=a.findNode(a.treeNodes,"childrens","_id",c._id);e&&(e.name=c.name)}d(function(){a.$apply()})}),a.destroyJSPlumb=function(){for(var b in a.jsPlumbConnections){var c=a.jsPlumbConnections[b];jsPlumb.detach(c)}a.jsPlumbConnections=[]},a.resourceIcon=function(a){switch(a){case"pdf":return"fa fa-file-pdf-o";case"mp4":return"fa fa-file-video-o";case"video":return"fa fa-file-video-o"}},a.getDataShape=function(a){return"subTopic"==a?"Ellipse":"Rectangle"},a.$on("onTopicHover",function(c,d){a.isRequesting||(a.isRequesting=!0,d=d.substring(1),b.get("/api/server-widgets/node-icon-analytics/?nodeId="+d).success(function(b){a.isRequesting=!1,b.result&&(a.widgets[d]=e.trustAsHtml(b.widgets))}).error(function(){a.isRequesting=!1}))}),a.$on("onTopicHoverOut",function(b,c){a.isRequesting=!1}),a.getContentNodeLink=function(b){return"#/cid/"+a.$parent.course._id+"/nid/"+b._id},a.deleteNode=function(c){var e="";e="subTopic"==c.type?"Are you sure you want to delete this sub topic?":"Are you sure you want to delete this content node?",confirm(e)&&b({method:"DELETE",url:"/api/treeNodes/"+c._id,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(c.isDeleted=!0,c.name="[DELETED]",d(function(){a.$apply()})):null==c.result||c.result||(a.errors=c.errors,console.log(c.errors))})}}]),app.controller("NodeDetailController",["$scope","$rootScope","$filter","$http","$location","$routeParams","$timeout","ActionBarService",function(a,b,c,d,e,f,g,h){a.course=null,a.user=null,a.treeNode=null,a.enrolled=!1,a.loc=e.absUrl(),a.courseId=f.courseId,a.nodeId=f.nodeId,a.isOwner=!1,a.isNodeOwner=!1,a.currentUrl=window.location.href,a.followUrl=a.currentUrl+"?enroll=1",a.currentTab="preview",a.tabs={preview:"Preview",analytics:"Analytics",updates:"Updates",links:"Links"},a.deleteNode=function(b){var c="Are you sure you want to delete this content node?";confirm(c)&&d({method:"DELETE",url:"/api/treeNodes/"+b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?console.log("node deleted"):null==data.result||data.result||(a.errors=data.errors,console.log(data.errors))})},a.manageActionBar=function(){"preview"==a.currentTab&&a.treeNode&&a.treeNode.createdBy==b.user._id&&(h.extraActionsMenu=[],h.extraActionsMenu.push({clickAction:a.deleteNode,clickParams:a.treeNode._id,title:'<i class="ionicons ion-close"></i> &nbsp;DELETE',aTitle:"DELETE THIS NODE AND ITS CONTENTS"}))},a.changeTab=function(){var b="preview",c=e.search();c.tab&&(b=c.tab),a.currentTab=b,a.actionBarTemplate="actionBar-node-"+a.currentTab,a.manageActionBar()},a.currentNodeAction={},a.setEditMode=function(){a.currentNodeAction.mode="edit",a.currentNodeAction.type="contentNode",a.currentNodeAction.typeText="Content Node",a.nodeModaltitle="Edit "+a.currentNodeAction.typeText,b.$broadcast("onAfterSetMode",a.course,a.treeNode)},a.initNode=function(){d.get("/api/treeNode/"+a.nodeId).success(function(c){c.result&&(a.treeNode=c.treeNode,a.treeNode.createdBy==b.user._id&&(a.isNodeOwner=!0,a.setEditMode()),a.manageActionBar(),g(function(){a.$broadcast("onAfterInitTreeNode",a.treeNode)}))})},a.init=function(){d.get("/api/course/"+a.courseId).success(function(b){b.result&&(a.course=b.course,a.initNode(),g(function(){a.$broadcast("onAfterInitCourse",a.course)}))}),a.changeTab()},a.init(),b.$watch("user",function(){b.user&&(a.user=b.user)}),a.$watchGroup(["user","course"],function(){null!=a.user&&null!=a.course&&(d.get("/api/accounts/"+a.user._id+"/course/"+a.courseId).success(function(b){b.result&&b.courses?a.enrolled=b.courses.isEnrolled:a.enrolled=!1}),a.course.createdBy==b.user._id&&(a.isOwner=!0,a.enrolled=!0))}),a.$on("$routeUpdate",function(){a.changeTab()})}]),app.controller("NodeEditController",["$scope","$http","$rootScope","Upload",function(a,b,c,d){a.formData={},a.filespdf=[],a.filesvideo=[],a.currentEditNode=!1,a.init=function(){},a.$on("onAfterSetMode",function(b,c,d){a.formData.courseId=c._id,a.currentNodeAction.parent&&(a.formData.parent=a.currentNodeAction.parent._id),a.currentEditNode=a.currentNodeAction.parent,a.formData.type=a.currentNodeAction.type,d&&(a.formData.name=d.name,a.formData.nodeId=d._id,a.currentEditNode=d)}),a.parseNgFile=function(a){var b=a.type.split("/")[1],c={type:b};return c},a.saveNode=function(){var d=transformRequest(a.formData);b({method:"POST",url:"/api/treeNodes",data:d,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(c.$broadcast("onAfterCreateNode",b.treeNode),$("#addSubTopicModal").modal("hide"),$("#addContentNodeModal").modal("hide"),a.formData.parent&&delete a.formData.parent,a.formData.name=""):b.result||(a.errors=b.errors,console.log(b.errors))})},a.saveEditNode=function(){var d={name:a.currentEditNode.name},e=transformRequest(d);b({method:"PUT",url:"/api/treeNodes/"+a.currentEditNode._id,data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(c.$broadcast("onAfterEditNode",b.treeNode),$("#editSubTopicModal").modal("hide"),$("#editContentNodeModal").modal("hide")):b.result||(a.errors=b.errors,console.log(b.errors))})},a.saveContentNode=function(){if("edit"==a.currentNodeAction.mode)return void a.saveEditNode();var b={url:"/api/treeNodes",fields:a.formData};b.file=[],a.filespdf&&a.filespdf.length&&b.file.push(a.filespdf[0]),a.filesvideo&&a.filesvideo.length&&b.file.push(a.filesvideo[0]),d.upload(b).progress(function(a){if(a.config.file){var b=parseInt(100*a.loaded/a.total);console.log("progress: "+b+"% "+a.config.file.name)}}).success(function(d,e,f,g){if(console.log(d),d.result){d.treeNode.resources=[];for(var h in b.file){var i=b.file[h],j=a.parseNgFile(i);d.treeNode.resources.push(j)}c.$broadcast("onAfterCreateNode",d.treeNode),$("#addSubTopicModal").modal("hide"),$("#addContentNodeModal").modal("hide"),a.formData.name="",a.filespdf=[],a.filesvideo=[],a.formData.parent&&delete a.formData.parent}else d.result||(a.errors=d.errors,console.log(d.errors))})}}]),app.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$last===!0&&a(function(){b.$emit(d.onFinishRender)})}}}]),app.directive("script",["$parse","$rootScope","$compile",function(a,b,c){return{restrict:"E",terminal:!0,link:function(a,b,d){if(d.ngSrc){var e='<script src="'+d.ngSrc+'" async defer></script>';$(b).append(c(e)(a))}}}}]),app.directive("movable",function(){return{restrict:"A",scope:{onMoved:"=",canMove:"@"},link:function(a,b,c){c.$observe("canMove",function(a){"false"===a?(console.log("Disabling draggable and resizable"),b.draggable({disabled:!0}).resizable({disabled:!0})):(console.log("Enabling draggable and resizable"),b.draggable({disabled:!1}).resizable({disabled:!1}))});var d=function(a){var c={left:Math.round(100*a.position.left/b.parent()[0].clientWidth),top:Math.round(100*a.position.top/b.parent()[0].clientHeight)};return console.log(c),c};console.log("Initializing draggable and resizable"),b.draggable({containment:"parent",cursor:"move",stop:function(b,c){a.onMoved&&a.onMoved({position:d(c)})}}).resizable({containment:"parent",handles:"ne, se, sw, nw",stop:function(b,c){a.onMoved&&a.onMoved({position:d(c),size:c.size})}}),a.$on("$destroy",function(){b.off("**")})}}}),app.controller("DiscussionController",["$scope","$rootScope","$http","$location","$sce","$compile","ActionBarService","$timeout",function(a,b,c,d,e,f,g,h){a.formData={},a.course={},a.currentReplyingTo=!1,a.currentEditPost={},a.currentTopic=!1,a.originalCurrentTopic={},a.pid=!1,a.menu=[["bold","italic","underline","strikethrough","subscript","superscript"],["font-size"],["ordered-list","unordered-list","outdent","indent"],["left-justify","center-justify","right-justify"],["code","quote","paragraph"]],a.topics=[],a.replies=[],a.initiateTopic=function(){a.pid=d.search().pid,a.pid&&a.getReplies(a.pid),a.manageActionBar()},a.$on("onAfterInitCourse",function(b,d){a.course=d,c.get("/api/discussions/"+d._id).success(function(b){b.result&&b.posts&&(a.topics=b.posts,a.initiateTopic())})}),a.$on("onAfterCreateReply",function(c,d){d&&(d.createdBy=b.user,a.replies.unshift(d))}),a.saveNewPost=function(){console.log("saving");var b=transformRequest(a.formData);c({method:"POST",url:"/api/discussions/"+a.course._id,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(a.$emit("onAfterCreateNewTopic",b.post),a.topics.unshift(b.post),h(function(){a.$apply()}),$("#addNewTopicModal").modal("hide")):null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})},a.saveEditPost=function(){console.log("saving edit post");var b=transformRequest(a.currentTopic);c({method:"PUT",url:"/api/discussion/"+a.currentTopic._id,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){if(console.log(b),b.result){a.$emit("onAfterEditTopic",b.post),$("#editTopicModal").modal("hide");var c=_.findIndex(a.topics,{discussion:{_id:b.post._id}});a.topics[c].discussion=b.post,h(function(){a.$apply()})}else null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})},a.editReply=function(b){a.currentEditPost=b,a.$broadcast("onEditReplyClicked",b)},a.deletePost=function(b){c({method:"DELETE",url:"/api/discussion/"+b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c){console.log(c),c.result?a.$emit("onAfterDeletePost",b):null==c.result||c.result||(a.errorName=c.errors,console.log(c.errors))})},a.deleteTopic=function(b){var d=confirm("Are you sure you want to delete this topic?");1==d&&c({method:"DELETE",url:"/api/discussions/"+a.course._id+"/topic/"+b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c){console.log(c),c.result?a.$emit("onAfterDeleteTopic",b):null==c.result||c.result||(a.errorName=c.errors,console.log(c.errors))})},a.$on("$routeUpdate",function(){a.initiateTopic()}),a.$on("onAfterCreateNewTopic",function(b,c){a.formData.title="",a.formData.content=""}),a.$on("onAfterEditReply",function(b,c){var d=_.findIndex(a.replies,{_id:c._id});a.replies[d].content=c.content,h(function(){a.$apply()})}),a.$on("onAfterDeletePost",function(b,c){var d=_.findIndex(a.replies,{_id:c});a.replies[d].content="[DELETED]",h(function(){a.$apply()})}),a.$on("onAfterDeleteTopic",function(b,c){var e=_.findIndex(a.topics,{discussion:{_id:c}});e>=0&&(a.topics.splice(e,1),a.currentTopic=!1,a.replies=[],a.pid=!1,d.search("pid",""),a.initiateTopic(),h(function(){a.$apply()}))}),a.manageActionBar=function(){"discussion"==a.$parent.currentTab&&(a.pid?(g.extraActionsMenu=[],g.extraActionsMenu.push({separator:!0}),g.extraActionsMenu.push({html:'<a style="cursor: pointer;" data-toggle="modal" data-target="#addNewReplyModal" title="Reply">&nbsp;&nbsp; <i class="ionicons ion-reply"></i> &nbsp; REPLY</a>'}),a.currentTopic&&a.currentTopic.createdBy&&a.currentTopic.createdBy._id==b.user._id&&(g.extraActionsMenu.push({html:'<a style="cursor: pointer;" data-toggle="modal" data-target="#editTopicModal" title="Edit">&nbsp;&nbsp; <i class="ionicons ion-edit"></i> &nbsp; EDIT</a>'}),g.extraActionsMenu.push({clickAction:a.deleteTopic,clickParams:a.currentTopic._id,title:'<i class="ionicons ion-close"></i> &nbsp;DELETE',aTitle:"DELETE THIS TOPIC AND ITS REPLIES"}))):a.pid||(a.currentTopic={},g.extraActionsMenu=[]))},a.$on("onAfterInitUser",function(b,c){a.$watch("currentTopic",function(b,c){b!==c&&a.currentTopic&&a.currentTopic._id})}),a.getReplies=function(b){var d=_.findIndex(a.topics,{discussion:{_id:b}});a.topics[d]&&(a.currentTopic=cloneSimpleObject(a.topics[d].discussion),a.currentTopic.createdBy=a.topics[d].createdBy,a.originalCurrentTopic=cloneSimpleObject(a.topics[d].discussion),a.currentReplyingTo=a.currentTopic._id,c.get("/api/discussion/"+b+"/posts").success(function(b){b.result&&(a.replies=b.posts)}))},a.cancel=function(){a.currentTopic=a.originalCurrentTopic}}]),app.controller("ReplyController",["$scope","$http","$timeout",function(a,b,c){a.formData={title:" ",content:""},a.formNewData={title:" ",content:""},a.menu=[["bold","italic","underline","strikethrough","subscript","superscript"],["font-size"],["ordered-list","unordered-list","outdent","indent"],["left-justify","center-justify","right-justify"],["code","quote","paragraph"]],a.$on("onEditReplyClicked",function(b,c){a.formData.content=c.content,a.formData.postId=c._id}),a.saveNewReply=function(){console.log("saving reply to "+a.$parent.currentReplyingTo),a.formNewData.parentPost=a.$parent.currentReplyingTo;var d=transformRequest(a.formNewData);b({method:"POST",url:"/api/discussion/replies/",data:d,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(a.$emit("onAfterCreateReply",b.post),$("#addNewReplyModal").modal("hide"),a.formNewData.content="",c(function(){a.$apply()})):null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})},a.cancel=function(){a.formData.content="",a.formNewData.content="",c(function(){a.$apply()})},a.saveEditReply=function(){console.log("saving edit reply "+a.$parent.currentEditPost._id);var d=transformRequest(a.formData);b({method:"PUT",url:"/api/discussion/"+a.$parent.currentEditPost._id,data:d,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(a.$emit("onAfterEditReply",b.post),a.formData.content="",c(function(){a.$apply()}),$("#editReplyModal").modal("hide")):null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})},a.deletePost=function(c){b({method:"DELETE",url:"/api/discussion/"+c,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?a.$emit("onAfterDeletePost",c):null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})}}]),app.factory("socket",["$rootScope",function(a){var b=io.connect();return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}]),app.filter("capitalize",function(){return function(a,b){return a?a.replace(/([^\W_]+[^\s-]*) */g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}):""}}),app.filter("base64Encode",function(){return function(a,b){return a?Base64.encode(a):""}}),app.filter("base64Decode",function(){return function(a,b){return a?Base64.decode(a):""}}),app.filter("unsafe",["$sce",function(a){return a.trustAsHtml}]),function(){"use strict";angular.module("relativeDate",[]).value("now",null).value("relativeDateTranslations",{just_now:"just now",seconds_ago:"{{time}} seconds ago",a_minute_ago:"a minute ago",minutes_ago:"{{time}} minutes ago",an_hour_ago:"an hour ago",hours_ago:"{{time}} hours ago",a_day_ago:"yesterday",days_ago:"{{time}} days ago",a_week_ago:"a week ago",weeks_ago:"{{time}} weeks ago",a_month_ago:"a month ago",months_ago:"{{time}} months ago",a_year_ago:"a year ago",years_ago:"{{time}} years ago",over_a_year_ago:"over a year ago",seconds_from_now:"{{time}} seconds from now",a_minute_from_now:"a minute from now",minutes_from_now:"{{time}} minutes from now",an_hour_from_now:"an hour from now",hours_from_now:"{{time}} hours from now",a_day_from_now:"tomorrow",days_from_now:"{{time}} days from now",a_week_from_now:"a week from now",weeks_from_now:"{{time}} weeks from now",a_month_from_now:"a month from now",months_from_now:"{{time}} months from now",a_year_from_now:"a year from now",years_from_now:"{{time}} years from now",over_a_year_from_now:"over a year from now"}).filter("relativeDate",["$injector","now","relativeDateTranslations",function(a,b,c){var d,e;return d=a.has("$translate")?a.get("$translate"):{instant:function(a,b){return c[a].replace("{{time}}",b.time)}},e=function(a,b){return Math.round(Math.abs(a-b)/1e3)},function(a){var c,f,g,h,i,j,k,l,m;switch(j=b?b:new Date,a instanceof Date||(a=new Date(a)),f=null,h=60,g=60*h,c=24*g,l=7*c,i=30*c,m=365*c,f=e(j,a),f>c&&l>f&&(a=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0),f=e(j,a)),k=function(b,c){var e;return e="just_now"===b?b:j>=a?""+b+"_ago":""+b+"_from_now",d.instant(e,{time:c})},!1){case!(30>f):return k("just_now");case!(h>f):return k("seconds",f);case!(2*h>f):return k("a_minute");case!(g>f):return k("minutes",Math.floor(f/h));case 1!==Math.floor(f/g):return k("an_hour");case!(c>f):return k("hours",Math.floor(f/g));case!(2*c>f):return k("a_day");case!(l>f):return k("days",Math.floor(f/c));case 1!==Math.floor(f/l):return k("a_week");case!(i>f):return k("weeks",Math.floor(f/l));case 1!==Math.floor(f/i):return k("a_month");case!(m>f):return k("months",Math.floor(f/i));case 1!==Math.floor(f/m):return k("a_year");default:return k("over_a_year")}}}])}.call(this),app.filter("secondsToDateTime",[function(){return function(a){return new Date(1970,0,1).setSeconds(a)}}]),app.controller("LinksController",["$scope","$rootScope","$http","$location","$sce","$compile","ActionBarService","$timeout",function(a,b,c,d,e,f,g,h){a.formData={},a.course={},a.contentNode={},a.currentLink=!1,a.originalCurrentLink={},a.pid=!1,a.currentLinkUrl="",a.links=[],a.initiateLink=function(){a.pid=d.search().pid,a.manageActionBar(a.pid),a.pid&&a.setCurrentLink(a.pid)},a.$on("onAfterInitTreeNode",function(b,d){a.contentNode=d,c.get("/api/links/"+d._id).success(function(b){b.result&&b.posts&&(a.links=b.posts,a.initiateLink())})}),a.$on("onAfterInitCourse",function(b,c){a.course=c}),a.saveNewPost=function(){console.log("saving bookmark");var b=transformRequest(a.formData);c({method:"POST",url:"/api/links/"+a.contentNode._id,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result?(a.$emit("onAfterCreateNewLink",b.post),a.links.unshift(b.post),h(function(){a.$apply()}),$("#addNewLinksModal").modal("hide")):null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})},a.saveEditPost=function(){console.log("saving edit bookmark");var b=transformRequest(a.currentLink);c({method:"PUT",url:"/api/links/"+a.currentLink._id,data:b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){if(console.log(b),b.result){a.$emit("onAfterEditLinks",b.post),$("#editLinksModal").modal("hide");var c=_.findIndex(a.links,{link:{_id:b.post._id}});a.links[c].link=b.post,h(function(){a.$apply()})}else null==b.result||b.result||(a.errorName=b.errors,console.log(b.errors))})},a.deletePost=function(b){var d=confirm("Are you sure you want to delete this link?");1==d&&c({method:"DELETE",url:"/api/links/"+a.contentNode._id+"/link/"+b,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(c){console.log(c),c.result?a.$emit("onAfterDeleteLink",b):null==c.result||c.result||(a.errorName=c.errors,console.log(c.errors))})},a.$on("$routeUpdate",function(){a.initiateLink()}),a.$on("onAfterDeleteLink",function(b,c){var e=_.findIndex(a.links,{link:{_id:c}});e>=0&&(a.links.splice(e,1),a.currentLink=!1,a.pid=!1,d.search("pid",""),a.initiateLink(),h(function(){a.$apply()}))}),a.manageActionBar=function(){"links"==a.$parent.currentTab&&(a.pid?(g.extraActionsMenu=[],g.extraActionsMenu.unshift({separator:!0})):a.pid||(a.currentLink={},g.extraActionsMenu=[]))},a.$on("onAfterInitUser",function(c,d){a.$watch("currentLink",function(c,d){a.currentLink&&a.currentLink.createdBy&&a.currentLink.createdBy._id==b.user._id&&(g.extraActionsMenu.push({html:'<a style="cursor: pointer;" data-toggle="modal" data-target="#editLinksModal" title="Edit">&nbsp;&nbsp; <i class="ionicons ion-edit"></i> &nbsp; EDIT</a>'}),g.extraActionsMenu.push({clickAction:a.deletePost,clickParams:a.currentLink._id,title:'<i class="ionicons ion-close"></i> &nbsp;DELETE',aTitle:"DELETE"}))})}),a.setCurrentLink=function(b){var c=_.findIndex(a.links,{link:{_id:b}});a.links[c]&&(a.currentLink=cloneSimpleObject(a.links[c].link),a.currentLink.createdBy=a.links[c].createdBy,a.originalCurrentLink=cloneSimpleObject(a.links[c].link),a.currentLinkUrl=e.trustAsResourceUrl(a.currentLink.content))},a.cancel=function(){a.currentLink=a.originalCurrentLink},a.getSrc=function(a){return e.trustAsResourceUrl(a)}}]),app.controller("PDFNavigationController",["$scope","$http","$rootScope","$sce","$timeout",function(a,b,c,d,e){a.currentPageNumber=1,a.maxPageNumber=30,a.changePageNumber=function(b){console.log("GOT CALLED"),a.currentPageNumber+b<=a.maxPageNumber&&a.currentPageNumber+b>=1&&(a.currentPageNumber=a.currentPageNumber+b),changeSlide(a.currentPageNumber)}}]),app.controller("AnnotationZoneListController",["$scope","$http","$rootScope","$sce","$timeout",function(a,b,c,d,e){b.get("/slide-viewer/disAnnZones").success(function(b){console.log("TAGS UPDATED"),a.annZones=b.annZones,tagListLoaded(a.annZones),e(function(){a.$apply()})})}]),app.controller("CommentListController",["$scope","$http","$rootScope","$sce","$timeout",function(a,b,c,d,e){function f(c){b.get(c).success(function(b){console.log("COMMENTS UPDATED"),console.log("url: "+c),a.comments=b.comments;for(var f in a.comments){var g=a.comments[f];g.html=d.trustAsHtml(g.html),e(function(){a.$apply(),commentsLoaded()})}})}function g(b){var c;if(0==a.filtersRaw.length)c="{}";else{var d=a.filtersRaw.split(";");c="{";for(var e=0;e<d.length;e++){var f=d[e].split(",");1!=f.length?c=c+'"'+f[0]+'":"'+f[1]+'"':(f=d[e].split(":"),"undefined"!=typeof f[1]&&(c="#"==f[1].charAt(0)?c+'"'+f[0]+'":{"regex_hash": "'+f[1].substring(1)+'"}':c+'"'+f[0]+'":{"regex": "'+f[1].substring(1)+'"}')),e!=d.length-1&&(c+=",")}c+="}"}return console.log("Final Filters: "+c),c}a.orderType="author",a.ascending="true",a.filters="{}",a.filtersRaw="",a.commentGetUrl='/slide-viewer/disComm/{"type":"'+a.orderType+'","ascending":"'+a.ascending+'"}/'+a.filters,a.$watch("orderType",function(b,c){a.commentGetUrl='/slide-viewer/disComm/{"type":"'+a.orderType+'","ascending":"'+a.ascending+'"}/'+a.filters,f(a.commentGetUrl)}),a.$watch("ascending",function(b,c){a.commentGetUrl='/slide-viewer/disComm/{"type":"'+a.orderType+'","ascending":"'+a.ascending+'"}/'+a.filters,
f(a.commentGetUrl)}),a.$watch("filtersRaw",function(b,c){a.filters=g(a.filtersRaw),a.commentGetUrl='/slide-viewer/disComm/{"type":"'+a.orderType+'","ascending":"'+a.ascending+'"}/'+a.filters,console.log("commentGetUrl: "+a.commentGetUrl),f(a.commentGetUrl)})}]),app.controller("HomePageController",["$scope","$http","$rootScope","$sce",function(a,b,c,d){a.hideSlider=!1,a.isRequesting=!1,a.widgets=[],$(document).ready(function(){"undefined"!=typeof localStorage&&localStorage.hideSlider&&(a.hideSlider=localStorage.hideSlider),a.width=jQuery(window).width(),a.height=jQuery(window).height(),a.center={x:a.width/2,y:a.height/2-100}}),b.get("/api/categories").success(function(b){b.categories?a.categories=b.categories:a.categories=!1}),a.setHideSlider=function(){a.hideSlider=!0,"undefined"!=typeof localStorage&&(localStorage.hideSlider=!0)},a.$watch("hideSlider",function(){a.hideSlider}),a.$on("jsTreeInit",function(b){console.log(b),a.initJSPlumb()}),a.initJSPlumb=function(){Tree.init(Canvas.w,Canvas.h);var b=jsPlumb.getInstance({Endpoint:["Blank",{radius:2}],HoverPaintStyle:{strokeStyle:"#3C8DBC",lineWidth:2},PaintStyle:{strokeStyle:"#3C8DBC",lineWidth:2},ConnectionOverlays:[],Container:"category-map"});c.initDraggable(b),b.batch(function(){a.interConnect("center",a.categories,b)})},a.interConnect=function(b,d,e){for(var f in d){var g=d[f];$("#"+g.slug).mouseover(function(a){$(this).find("ul").show(),c.$broadcast("onCategoryHover",$(this).attr("id"))}).mouseout(function(){$(this).find("ul").hide(),c.$broadcast("onCategoryHoverOut",$(this).attr("id"))}),e.connect({source:b,target:g.slug,anchors:[["Perimeter",{shape:jsPlumb.getSelector("#"+b)[0].getAttribute("data-shape")}],["Perimeter",{shape:jsPlumb.getSelector("#"+g.slug)[0].getAttribute("data-shape")}]]}),g.subCategories&&a.interConnect(g.slug,g.subCategories,e)}},a.$on("onCategoryHover",function(c,e){a.isRequesting||(a.isRequesting=!0,b.get("/api/server-widgets/category-homepage/?slug="+e).success(function(b){a.isRequesting=!1,b.result&&(a.widgets[e]=d.trustAsHtml(b.widgets))}).error(function(){a.isRequesting=!1}))}),a.$on("onCategoryHoverOut",function(b,c){a.isRequesting=!1}),a.goToDetail=function(a){window.location.href="/courses/#/category/"+a}}]),app.controller("MainMenuController",["$scope","$http","$rootScope","$cookies",function(a,b,c,d){a.rememberMe=!1,b.get("/api/accounts").success(function(b){a.user=b,c.user=b,c.$broadcast("onAfterInitUser",b)}),d.rememberMe&&(a.rememberMe=d.rememberMe),a.$watch("rememberMe",function(b,c){b!==c&&(d.rememberMe=a.rememberMe)})}]),app.controller("ActionBarController",["$scope","ActionBarService","$sce","$compile",function(a,b,c,d){a.extraActionsMenu=[],a.$watch(function(){return b.extraActionsMenu},function(c){a.extraActionsMenu=b.extraActionsMenu})}]),app.service("ActionBarService",function(){this.extraActionsMenu=[]}),app.controller("staticController",["$scope","$http","$rootScope",function(a,b,c){}]),app.controller("UserEditController",["$scope","$http","$rootScope","$timeout",function(a,b,c,d){a.user={},a.formData={},a.errors=null,a.$on("onAfterInitUser",function(b,c){a.user=c}),a.saveEditUser=function(){if(a.formData.password==a.formData.passwordConfirm){var c=transformRequest(a.formData);b({method:"PUT",url:"/api/accounts/"+a.user._id+"/changePassword",data:c,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(b){console.log(b),b.result&&(a.$emit("init"),$("#editAccountModal").modal("hide"))}).error(function(b){b.result||(a.errors=b.errors,console.log(b.errors))})}},a.cancel=function(){$("#editAccountModal").modal("hide")}}]),app.controller("widgetController",["$scope","$http","$rootScope","$timeout",function(a,b,c,d){a.location="",a.widgets=[],a.initWidgetButton=function(b){$.AdminLTE.boxWidget.activate(),a.addWidget(b)},a.$on("onAfterInitUser",function(b,c){a.$watch("location",function(b,c){"user-profile"==a.location&&(console.log("onAfterInitUser"),a.getWidgets())})}),a.$on("onAfterInitCourse",function(b,c){console.log("onAfterInitCourse"),a.course=c,a.getWidgets()}),a.$watch("location",function(b,c){var d="onAfterInstall"+a.location;a.$on(d,function(b,c){var d=$("#"+a.location+"-widgets").data("gridstack");d.remove_all(),a.getWidgets()});var d="onAfterUninstall"+a.location;a.$on(d,function(b,c){var d=$("#"+a.location+"-widgets").data("gridstack");d.remove_all(),a.getWidgets()});var e="OnAfterWidgetLoaded"+a.location;a.$on(e,function(){})}),a.getWidgets=function(){var d="";"user-profile"==a.location?d=c.user._id:("course-preview"==a.location||"course-analytics"==a.location)&&(d=a.course._id),b.get("/api/widgets/"+a.location+"/"+d).success(function(b){a.widgets=b.widgets,c.$broadcast("onAfterGetWidgets"+a.location,a.widgets)})},a.addWidget=function(b){var c="#"+a.location+"-widgets",d=$(c).data("gridstack"),e="#w"+b,f=_.findIndex(a.widgets,{widgetId:{_id:b}}),g=a.widgets[f],h=0,i=0;g.position&&(h=g.position.x,i=g.position.y),d.add_widget(e,h,i,g.width,g.height,!1)},a.closeWidget=function(b){var d=_.findIndex(a.widgets,{widgetId:{_id:b}}),e=a.widgets[d];c.$broadcast("onAfterCloseButtonClicked"+a.location,e)},a.initiateDraggableGrid=function(b){a.location=b;var c="#"+b+"-widgets",d={cell_height:340,vertical_margin:10,resizable:!1},e={x:0,y:0},f=$(c);f.gridstack(d),f.on("onStartMove",function(a,b){e.x=b.x,e.y=b.y}),f.on("onMove",function(a,b){console.log(b.x+" ++ "+b.y)}),f.on("onFinishDrop",function(b,c){var f=$(c.el);d.allowed_grids&&d.allowed_grids.indexOf(c.x)<0&&f.attr("data-gs-x",e.x).attr("data-gs-y",e.y),console.log("onFinishDrop");var g=f.attr("id").substr(1);a.setPosition(g,c.x,c.y)})},a.setPosition=function(a,c,d){b.put("/api/widget/"+a+"/setPosition/",{x:c,y:d}).success(function(a){a.result&&console.log("set position success")})},a.populateWidgets=function(){for(var b in a.widgets)a.addWidget(a.widgets[b].widgetId._id)}}]),app.controller("WidgetGalleryController",["$scope","$http","$rootScope","$ocLazyLoad","$timeout",function(a,b,c,d,e){a.location="",a.installedWidgets,a.initData=function(c){a.location=c,b.get("/api/widgets/"+c).success(function(b){a.widgets=b.widgets})},a.$watch("location",function(b,c){var e="onAfterGetWidgets"+a.location;a.$on(e,function(b,c){a.installedWidgets=c;for(var e in a.installedWidgets){var f=a.installedWidgets[e];d.load("/"+f.application+"/"+f.application+".js")}});var f="onAfterCloseButtonClicked"+a.location;a.$on(f,function(b,c){a.uninstall(c.location,c.application,c.widget,c.courseId)})}),a.isInstalled=function(b){if(a.installedWidgets){var c=_.find(a.installedWidgets,{widgetId:{_id:b}});return c}return!1},a.install=function(d,e,f,g){var h={application:e,widget:f,location:d};g&&(h.courseId=g),b.put("/api/widgets/install",h).success(function(b){b.result&&(a.installedWidget=b.installed),$("#widgetGallery").modal("hide"),c.$broadcast("onAfterInstall"+d,a.installedWidget)})},a.uninstall=function(d,e,f,g){var h={application:e,widget:f,location:d};g&&(h.courseId=g),b.put("/api/widgets/uninstall",h).success(function(b){b.result&&(a.uninstalledWidget=b.uninstalled),$("#widgetGallery").modal("hide"),c.$broadcast("onAfterUninstall"+d,a.uninstalledWidget)})}}]);